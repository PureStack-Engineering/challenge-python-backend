name: PureStack Backend Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit-backend:
    runs-on: ubuntu-latest
    name: ğŸš€ Microservice Quality Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Phase 1 Structural Integrity
        run: |
          echo "::group::Architecture Validation"
          if [ ! -f "src/main.py" ]; then echo "âŒ Missing: src/main.py"; exit 1; fi
          if [ ! -d "src/services" ]; then echo "âŒ Missing Folder: src/services/"; exit 1; fi
          if [ ! -d "src/models" ]; then echo "âŒ Missing Folder: src/models/"; exit 1; fi
          if [ ! -f "Dockerfile" ]; then echo "âŒ Missing: Dockerfile"; exit 1; fi
          echo "âœ… Project Structure follows PureStack Standards."
          echo "::endgroup::"

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx

      - name: ğŸ•µï¸ Phase 2 Anti-Pattern Detection
        run: |
          echo "::group::Static Code Analysis"
          if grep -r "print(" src/; then echo "âŒ CRITICAL: 'print()' detected. Use logging."; exit 1; fi
          if grep -r "time.sleep" src/; then echo "âŒ CRITICAL: Blocking 'time.sleep' detected. Use 'await asyncio.sleep()'."; exit 1; fi
          echo "âœ… Code is clean of blocking calls."
          echo "::endgroup::"

      - name: ğŸ§ª Phase 3 Functional Validation
        run: |
          PYTHONPATH=. pytest tests/ -v

      - name: ğŸ³ Phase 4 Container Build
        run: |
          echo "::group::Docker Build Test"
          # Intenta construir la imagen. FallarÃ¡ si el Dockerfile estÃ¡ vacÃ­o o mal hecho.
          docker build . -t purestack-validator:latest
          echo "âœ… Dockerfile is valid."
          echo "::endgroup::"
