name: PureStack Backend Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  audit-backend:
    runs-on: ubuntu-latest
    name: ğŸš€ Microservice Quality Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Phase 1: Structural Integrity
        run: |
          echo "::group::Architecture Validation"
          # 1. Check Entry Point
          if [ ! -f "src/main.py" ]; then echo "âŒ Missing: src/main.py"; exit 1; fi
          
          # 2. Check Service Layer Pattern (Level 2 Requirement)
          if [ ! -d "src/services" ]; then echo "âŒ Missing Folder: src/services/ (Required for Layered Arch)"; exit 1; fi
          if [ ! -d "src/models" ]; then echo "âŒ Missing Folder: src/models/ (Required for Pydantic Schemas)"; exit 1; fi
          
          # 3. Check Dockerfile (Level 1 Requirement)
          if [ ! -f "Dockerfile" ]; then echo "âŒ Missing: Dockerfile"; exit 1; fi
          
          echo "âœ… Project Structure follows PureStack Microservice Standards."
          echo "::endgroup::"

      - name: ğŸ Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest httpx # Required for TestClient

      - name: ğŸ•µï¸ Phase 2: Anti-Pattern Detection
        run: |
          echo "::group::Static Code Analysis"
          
          # Ban 'print(' -> Enforce Logging
          if grep -r "print(" src/; then 
            echo "âŒ CRITICAL: 'print()' detected. Use Python 'logging' module or 'structlog'."
            exit 1
          fi
          
          # Ban blocking sleep -> Enforce asyncio.sleep
          if grep -r "time.sleep" src/; then 
            echo "âŒ CRITICAL: Blocking 'time.sleep' detected in Async framework. Use 'await asyncio.sleep()'."
            exit 1
          fi
          
          echo "âœ… Code is clean of blocking calls and dirty logs."
          echo "::endgroup::"

      - name: ğŸ§ª Phase 3: Functional Validation
        run: |
          # PYTHONPATH=. makes 'src' importable
          PYTHONPATH=. pytest tests/ -v

      - name: ğŸ³ Phase 4: Container Build (Level 1 Check)
        run: |
          echo "::group::Docker Build Test"
          docker build . -t purestack-validator:latest
          echo "âœ… Dockerfile is valid and builds successfully."
          echo "::endgroup::"
